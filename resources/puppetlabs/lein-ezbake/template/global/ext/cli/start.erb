#!/usr/bin/env bash
pid=$(pgrep -f <%= EZBake::Config[:uberjar_name] %>)

set -e

restartfile=<%= EZBake::Config[:restart_file] %>
start_timeout=<%= EZBake::Config[:start_timeout] %>
stop_timeout=60
dir=$(dirname "$restartfile")
realname="<%= EZBake::Config[:real_name] %>"
PIDFILE="/var/run/puppetlabs/${realname}/${realname}.pid"

write_pid_file() {
    if [ ! -d "/var/run/puppetlabs/${realname}" ]; then
        mkdir -p /var/run/puppetlabs/${realname}
        chown -R $USER:$GROUP /var/run/puppetlabs/${realname}
    fi
    echo $1 > $PIDFILE
}

terminate_java_process() {
    set +e
    echo "Startup script was terminated before completion" 1>&2
    kill -TERM $pid 2>/dev/null
    if [ $? == 0 ]; then
        kill -0 $pid 2>/dev/null
        timeout=$stop_timeout
        while [[ $? == 0 && "$timeout" != 0 ]]; do
            sleep 1
            ((timeout--))
            kill -0 $pid 2>/dev/null
        done
        if [ "$timeout" = 0 ]; then
          echo "Java process not terminated gracefully after $stop_timeout seconds" 1>&2
          kill -KILL $pid 2>/dev/null
        fi
    fi
    rm -f "$PIDFILE"
    set -e
    exit 1
}

if [ ! -z $pid ]; then
    write_pid_file $pid
    exit 0
fi

rm -f "$PIDFILE"

if [ ! -z "$restartfile" ]; then
    if [ ! -e "$restartfile" ]; then
        mkdir -p "$dir"
        echo -n "0" > "$restartfile"
    elif [ ! -r "$restartfile" ] || [ ! -w "$restartfile" ]; then
        echo "The restart-file at <%= EZBake::Config[:restart_file] %> is not readable and/or writeable." 1>&2
        exit 1
    fi
fi

${JAVA_BIN} ${JAVA_ARGS} -Djava.security.egd=/dev/urandom -cp ${INSTALL_DIR}/<%= EZBake::Config[:uberjar_name] %> clojure.main -m <%= EZBake::Config[:main_namespace] %> --config "${CONFIG}" -b "${BOOTSTRAP_CONFIG}" &

pid=$!
trap terminate_java_process SIGHUP SIGINT SIGTERM
write_pid_file $pid

if [ ! -z "$restartfile" ]; then
    cur=$(head -n 1 "$restartfile")
    initial=$cur

    timeout=$start_timeout
    set +e
    while [ "$cur" == "$initial" ] ;do
        kill -0 $pid 2>/dev/null
        sleep 1
        cur=$(head -n 1 "$restartfile")

        ((timeout--))
        if [ "$timeout" = 0 ]; then
            echo "Startup timed out after <%= EZBake::Config[:start_timeout] %> seconds" 1>&2
            exit 1
        fi
    done
    set -e
fi

exit 0
